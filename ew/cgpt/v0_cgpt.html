<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Road Survey Visualizer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    canvas {
      width: 100% !important;
      max-height: 400px;
    }
    .chart-container {
      margin-bottom: 30px;
    }
    .fullscreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      z-index: 9999;
      padding: 20px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h2>Road Survey Visualizer</h2>
  <input type="file" id="fileInput" accept=".csv" />
  <br><br>
  <label><input type="radio" name="view" value="simplified" checked> Simplified View</label>
  <label><input type="radio" name="view" value="comprehensive"> Comprehensive View</label>
  <br><br>
  <div class="chart-container">
    <h3>Plan View (Easting vs Northing)</h3>
    <canvas id="planChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>L-section View (Chainage vs Elevation)</h3>
    <canvas id="lSectionChart"></canvas>
  </div>

  <script>
    let planChart, lSectionChart;

    document.getElementById("fileInput").addEventListener("change", handleFile);
    document.querySelectorAll("input[name='view']").forEach(el => el.addEventListener('change', redraw));

    let parsedData = [];

    // function handleFile(event) {
    //   const file = event.target.files[0];
    //   const reader = new FileReader();
    //   reader.onload = function(e) {
    //     const lines = e.target.result.split("\n").filter(line => line.trim().length > 0);
    //     parsedData = lines.map(row => {
    //       const cols = row.split(',').map(val => val.trim());
    //       return {
    //         point: parseInt(cols[0]),
    //         easting: parseFloat(cols[1]),
    //         northing: parseFloat(cols[2]),
    //         elevation: parseFloat(cols[3]),
    //         chainage: parseFloat(cols[4]),
    //         offset: parseFloat(cols[5])
    //       };
    //     });
    //     redraw();
    //   };
    //   reader.readAsText(file);
    // }

    function handleFile(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split("\n").filter(line => line.trim().length > 0);
        parsedData = [];

        for (const row of lines) {
          const cols = row.split(',').map(val => val.trim());

          // Skip header or invalid lines
          if (cols.length < 6 || isNaN(parseFloat(cols[1]))) continue;

          parsedData.push({
            point: parseInt(cols[0]),
            easting: parseFloat(cols[1]),
            northing: parseFloat(cols[2]),
            elevation: parseFloat(cols[3]),
            chainage: parseFloat(cols[4]),
            offset: parseFloat(cols[5])
          });
        }

        console.log("Parsed Data Sample:", parsedData.slice(0, 5));  // Check sample
        redraw();
      };
      reader.readAsText(file);
    }


    function redraw() {
      const view = document.querySelector("input[name='view']:checked").value;

      const groupedByOffset = {};
      parsedData.forEach(point => {
        if (!groupedByOffset[point.offset]) groupedByOffset[point.offset] = [];
        groupedByOffset[point.offset].push(point);
      });

      Object.keys(groupedByOffset).forEach(key => {
        groupedByOffset[key].sort((a, b) => a.chainage - b.chainage);
      });

      const colorMap = {
        '-16': 'red',
        '0': 'black',
        '16': 'blue'
      };

      const planDatasets = [];
      const lSectionDatasets = [];

      Object.entries(groupedByOffset).forEach(([offset, points]) => {
        if (view === 'simplified' && !['-16', '0', '16'].includes(offset)) return;
        const label = `Offset ${offset}`;
        const color = colorMap[offset] || `hsl(${(parseFloat(offset) + 16) * 10}, 70%, 50%)`;

        planDatasets.push({
          label,
          borderColor: color,
          data: points.map(p => ({x: p.easting, y: p.northing})),
          fill: false
        });

        lSectionDatasets.push({
          label,
          borderColor: color,
          data: points.map(p => ({x: p.chainage, y: p.elevation})),
          fill: false
        });
      });

      if (planChart) planChart.destroy();
      if (lSectionChart) lSectionChart.destroy();

      const ctxPlan = document.getElementById('planChart').getContext('2d');
      planChart = new Chart(ctxPlan, {
        type: 'line',
        data: { datasets: planDatasets },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { x: { title: { display: true, text: 'Easting' } }, y: { title: { display: true, text: 'Northing' } } }
        }
      });

      const ctxL = document.getElementById('lSectionChart').getContext('2d');
      lSectionChart = new Chart(ctxL, {
        type: 'line',
        data: { datasets: lSectionDatasets },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { x: { title: { display: true, text: 'Chainage (m)' } }, y: { title: { display: true, text: 'Elevation (m)' } } }
        }
      });
    }
  </script>
</body>
</html>

