<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMGSY Road Survey Data Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 600;
        }

        .header p {
            color: #5a6c7d;
            font-size: 1.1em;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-label:hover {
            background: linear-gradient(45deg, #2980b9, #1abc9c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .view-toggle {
            display: inline-flex;
            background: #ecf0f1;
            border-radius: 25px;
            padding: 4px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .view-toggle button.active {
            background: #3498db;
            color: white;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .visualization-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .chart-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fullscreen-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .fullscreen-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .chart-container {
            width: 100%;
            height: 400px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .chart-container canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .legend {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .data-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .data-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .fullscreen-content {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .fullscreen-chart {
            width: 100%;
            height: calc(100% - 80px);
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        .fullscreen-chart canvas {
            width: 100%;
            height: 100%;
        }

        .fullscreen-close {
            position: absolute;
            top: 30px;
            right: 30px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            z-index: 1001;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .sample-data-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .sample-data-btn:hover {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .visualization-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .view-toggle {
                align-self: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ£Ô∏è PMGSY Road Survey Data Visualizer</h1>
            <p>Professional tool for visualizing road survey data with plan and longitudinal section views</p>
        </div>

        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv,.txt" />
                <label for="csvFile" class="file-input-label">üìÅ Select Survey Data File</label>
            </div>
            
            <button class="sample-data-btn" onclick="loadSampleData()">üìä Load Sample Data</button>
            
            <div class="view-toggle">
                <button id="simplifiedView" class="active">Simplified View</button>
                <button id="comprehensiveView">Comprehensive View</button>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="loading" id="loading">Processing survey data...</div>

        <div class="visualization-container" id="charts" style="display: none;">
            <div class="chart-panel">
                <h3>
                    Plan View (Top View)
                    <button class="fullscreen-btn" onclick="openFullscreen('plan')">‚õ∂ Fullscreen</button>
                </h3>
                <div class="chart-container">
                    <canvas id="planChart"></canvas>
                </div>
                <div class="legend" id="planLegend"></div>
            </div>

            <div class="chart-panel">
                <h3>
                    Longitudinal Section (L-Section)
                    <button class="fullscreen-btn" onclick="openFullscreen('lsection')">‚õ∂ Fullscreen</button>
                </h3>
                <div class="chart-container">
                    <canvas id="lsectionChart"></canvas>
                </div>
                <div class="legend" id="lsectionLegend"></div>
            </div>
        </div>

        <div class="data-info" id="dataInfo" style="display: none;">
            <h3>üìä Survey Data Statistics</h3>
            <div class="data-stats" id="dataStats"></div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <button class="fullscreen-close" onclick="closeFullscreen()">‚úï Close</button>
        <div class="fullscreen-content">
            <div class="fullscreen-chart">
                <canvas id="fullscreenCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let surveyData = [];
        let currentView = 'simplified';
        let currentFullscreenType = null;

        // Color schemes for different distance offsets
        const colorScheme = {
            '-16.000': '#e74c3c', '-14.000': '#e67e22', '-12.000': '#f39c12',
            '-10.000': '#f1c40f', '-8.000': '#2ecc71', '-6.000': '#1abc9c',
            '-4.000': '#3498db', '-2.000': '#9b59b6', '0.000': '#2c3e50',
            '2.000': '#9b59b6', '4.000': '#3498db', '6.000': '#1abc9c',
            '8.000': '#2ecc71', '10.000': '#f1c40f', '12.000': '#f39c12',
            '14.000': '#e67e22', '16.000': '#e74c3c'
        };

        // Sample data for testing
        const sampleData = `1,100.000,200.000,105.50,0.000,0.000
            2,99.500,199.900,105.45,0.000,-2.000
            3,100.500,200.100,105.55,0.000,2.000
            4,99.000,199.800,105.40,0.000,-4.000
            5,101.000,200.200,105.60,0.000,4.000
            6,98.500,199.700,105.35,0.000,-6.000
            7,101.500,200.300,105.65,0.000,6.000
            8,98.000,199.600,105.30,0.000,-8.000
            9,102.000,200.400,105.70,0.000,8.000
            10,97.500,199.500,105.25,0.000,-10.000
            11,102.500,200.500,105.75,0.000,10.000
            12,97.000,199.400,105.20,0.000,-12.000
            13,103.000,200.600,105.80,0.000,12.000
            14,96.500,199.300,105.15,0.000,-14.000
            15,103.500,200.700,105.85,0.000,14.000
            16,96.000,199.200,105.10,0.000,-16.000
            17,104.000,200.800,105.90,0.000,16.000
            18,100.100,210.000,105.60,10.000,0.000
            19,99.600,209.900,105.55,10.000,-2.000
            20,100.600,210.100,105.65,10.000,2.000
            21,99.100,209.800,105.50,10.000,-4.000
            22,101.100,210.200,105.70,10.000,4.000
            23,98.600,209.700,105.45,10.000,-6.000
            24,101.600,210.300,105.75,10.000,6.000
            25,98.100,209.600,105.40,10.000,-8.000
            26,102.100,210.400,105.80,10.000,8.000
            27,97.600,209.500,105.35,10.000,-10.000
            28,102.600,210.500,105.85,10.000,10.000
            29,97.100,209.400,105.30,10.000,-12.000
            30,103.100,210.600,105.90,10.000,12.000
            31,96.600,209.300,105.25,10.000,-14.000
            32,103.600,210.700,105.95,10.000,14.000
            33,96.100,209.200,105.20,10.000,-16.000
            34,104.100,210.800,106.00,10.000,16.000
            35,100.200,220.000,105.70,20.000,0.000
            36,99.700,219.900,105.65,20.000,-2.000
            37,100.700,220.100,105.75,20.000,2.000
            38,99.200,219.800,105.60,20.000,-4.000
            39,101.200,220.200,105.80,20.000,4.000
            40,98.700,219.700,105.55,20.000,-6.000
            41,101.700,220.300,105.85,20.000,6.000
            42,98.200,219.600,105.50,20.000,-8.000
            43,102.200,220.400,105.90,20.000,8.000
            44,97.700,219.500,105.45,20.000,-10.000
            45,102.700,220.500,105.95,20.000,10.000
            46,97.200,219.400,105.40,20.000,-12.000
            47,103.200,220.600,106.00,20.000,12.000
            48,96.700,219.300,105.35,20.000,-14.000
            49,103.700,220.700,106.05,20.000,14.000
            50,96.200,219.200,105.30,20.000,-16.000
            51,104.200,220.800,106.10,20.000,16.000`;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('csvFile').addEventListener('change', handleFileSelect);
            document.getElementById('simplifiedView').addEventListener('click', () => setView('simplified'));
            document.getElementById('comprehensiveView').addEventListener('click', () => setView('comprehensive'));
        }

        function loadSampleData() {
            showLoading();
            setTimeout(() => {
                try {
                    parseCSVData(sampleData);
                    generateVisualizations();
                    updateDataStatistics();
                    hideLoading();
                    showCharts();
                } catch (error) {
                    showError('Error loading sample data: ' + error.message);
                }
            }, 500);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSVData(e.target.result);
                    generateVisualizations();
                    updateDataStatistics();
                    hideLoading();
                    showCharts();
                } catch (error) {
                    showError('Error processing file: ' + error.message);
                }
            };
            reader.onerror = function() {
                showError('Error reading file. Please try again.');
            };
            reader.readAsText(file);
        }

        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            surveyData = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',').map(part => part.trim());
                if (parts.length >= 6) {
                    const point = {
                        sno: parseInt(parts[0]),
                        easting: parseFloat(parts[1]),
                        northing: parseFloat(parts[2]),
                        elevation: parseFloat(parts[3]),
                        chainage: parseFloat(parts[4]),
                        distance: parseFloat(parts[5]).toFixed(3)
                    };

                    // Validate data
                    if (isNaN(point.easting) || isNaN(point.northing) || 
                        isNaN(point.elevation) || isNaN(point.chainage)) {
                        console.warn(`Invalid data at line ${i + 1}:`, line);
                        continue;
                    }

                    surveyData.push(point);
                }
            }

            if (surveyData.length === 0) {
                throw new Error('No valid data found in the file. Please check the format.');
            }

            console.log(`Loaded ${surveyData.length} survey points`);
        }

        function setView(viewType) {
            currentView = viewType;
            
            // Update button states
            document.getElementById('simplifiedView').classList.toggle('active', viewType === 'simplified');
            document.getElementById('comprehensiveView').classList.toggle('active', viewType === 'comprehensive');
            
            if (surveyData.length > 0) {
                generateVisualizations();
            }
        }

        function generateVisualizations() {
            generatePlanView();
            generateLongitudinalSection();
        }

        function generatePlanView() {
            const canvas = document.getElementById('planChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (surveyData.length === 0) return;

            // Get unique distance values and filter based on view
            const distances = getDistancesForView();
            
            // Group data by distance
            const groupedData = {};
            distances.forEach(dist => {
                groupedData[dist] = surveyData.filter(point => point.distance === dist)
                    .sort((a, b) => a.chainage - b.chainage);
            });

            // Calculate bounds
            const allEastings = surveyData.map(p => p.easting);
            const allNorthings = surveyData.map(p => p.northing);
            const minEasting = Math.min(...allEastings);
            const maxEasting = Math.max(...allEastings);
            const minNorthing = Math.min(...allNorthings);
            const maxNorthing = Math.max(...allNorthings);

            const padding = 50;
            const scaleX = (canvas.width - 2 * padding) / (maxEasting - minEasting || 1);
            const scaleY = (canvas.height - 2 * padding) / (maxNorthing - minNorthing || 1);
            const scale = Math.min(scaleX, scaleY);

            function toCanvasX(easting) {
                return (easting - minEasting) * scale + padding;
            }

            function toCanvasY(northing) {
                return canvas.height - ((northing - minNorthing) * scale + padding);
            }

            // Draw grid
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = padding + (canvas.width - 2 * padding) * i / 10;
                const y = padding + (canvas.height - 2 * padding) * i / 10;
                
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }

            // Draw lines for each distance
            distances.forEach(dist => {
                if (groupedData[dist] && groupedData[dist].length > 1) {
                    ctx.strokeStyle = colorScheme[dist] || '#000000';
                    ctx.lineWidth = dist === '0.000' ? 3 : 2;
                    ctx.beginPath();
                    
                    groupedData[dist].forEach((point, index) => {
                        const x = toCanvasX(point.easting);
                        const y = toCanvasY(point.northing);
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    ctx.stroke();
                }
            });

            // Add axis labels
            ctx.fillStyle = '#2c3e50';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Easting ‚Üí', canvas.width / 2, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Northing ‚Üí', 0, 0);
            ctx.restore();

            // Update legend
            updateLegend('planLegend', distances);
        }

        function generateLongitudinalSection() {
            const canvas = document.getElementById('lsectionChart');
            const ctx = canvas.getContext('2d');
            
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (surveyData.length === 0) return;

            const distances = getDistancesForView();
            
            // Group data by distance
            const groupedData = {};
            distances.forEach(dist => {
                groupedData[dist] = surveyData.filter(point => point.distance === dist)
                    .sort((a, b) => a.chainage - b.chainage);
            });

            // Calculate bounds
            const allChainages = surveyData.map(p => p.chainage);
            const allElevations = surveyData.map(p => p.elevation);
            const minChainage = Math.min(...allChainages);
            const maxChainage = Math.max(...allChainages);
            const minElevation = Math.min(...allElevations);
            const maxElevation = Math.max(...allElevations);

            const padding = 50;
            const scaleX = (canvas.width - 2 * padding) / (maxChainage - minChainage || 1);
            const scaleY = (canvas.height - 2 * padding) / (maxElevation - minElevation || 1);

            function toCanvasX(chainage) {
                return (chainage - minChainage) * scaleX + padding;
            }

            function toCanvasY(elevation) {
                return canvas.height - ((elevation - minElevation) * scaleY + padding);
            }

            // Draw grid
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            
            // Vertical grid lines (chainage)
            const chainageStep = (maxChainage - minChainage) / 10;
            for (let i = 0; i <= 10; i++) {
                const chainage = minChainage + i * chainageStep;
                const x = toCanvasX(chainage);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                
                // Labels
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(chainage.toFixed(0), x, canvas.height - 30);
            }

            // Horizontal grid lines (elevation)
            const elevationStep = (maxElevation - minElevation) / 8;
            for (let i = 0; i <= 8; i++) {
                const elevation = minElevation + i * elevationStep;
                const y = toCanvasY(elevation);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Labels
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(elevation.toFixed(2), padding - 10, y + 3);
            }

            // Draw elevation profiles
            distances.forEach(dist => {
                if (groupedData[dist] && groupedData[dist].length > 1) {
                    ctx.strokeStyle = colorScheme[dist] || '#000000';
                    ctx.lineWidth = dist === '0.000' ? 3 : 2;
                    ctx.beginPath();
                    
                    groupedData[dist].forEach((point, index) => {
                        const x = toCanvasX(point.chainage);
                        const y = toCanvasY(point.elevation);
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    ctx.stroke();
                }
            });

            // Add axis labels
            ctx.fillStyle = '#2c3e50';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Chainage (m)', canvas.width / 2, canvas.height - 10);
            
            ctx.save();
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Elevation (m)', 0, 0);
            ctx.restore();

            updateLegend('lsectionLegend', distances);
        }

        function getDistancesForView() {
            if (currentView === 'simplified') {
                return ['-16.000', '0.000', '16.000'];
            } else {
                const uniqueDistances = [...new Set(surveyData.map(p => p.distance))];
                return uniqueDistances.sort((a, b) => parseFloat(a) - parseFloat(b));
            }
        }

        function updateLegend(legendId, distances) {
            const legend = document.getElementById(legendId);
            legend.innerHTML = '';
            
            distances.forEach(dist => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const color = document.createElement('div');
                color.className = 'legend-color';
                color.style.backgroundColor = colorScheme[dist] || '#000000';
                
                const label = document.createElement('span');
                const distanceValue = parseFloat(dist);
                let labelText = `${distanceValue}m`;
                if (distanceValue === 0) {
                    labelText += ' (Centerline)';
            
